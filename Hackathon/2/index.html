<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>動物園たんけん！自由研究メーカー</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Mochiy+Pop+One&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .font-jp-title {
            font-family: 'Mochiy Pop One', sans-serif;
        }
        .page {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .error-message {
            display: none;
            color: #c53030;
            background-color: #fed7d7;
            border: 1px solid #f56565;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            text-align: center;
        }
    </style>
</head>
<body class="bg-green-50 text-gray-800">

    <div id="app" class="container mx-auto p-4 max-w-2xl">

        <!-- Header -->
        <header class="text-center p-6 bg-white rounded-xl shadow-lg border-4 border-yellow-300 mb-8">
            <h1 class="font-jp-title text-3xl md:text-4xl text-green-700">動物園たんけん！</h1>
            <h2 class="font-jp-title text-4xl md:text-5xl text-green-800">自由研究メーカー</h2>
            <p class="mt-2 text-gray-600">きみの「なぜ？」が「発見」に変わる！</p>
        </header>

        <!-- Page 1: Input -->
        <div id="page-input" class="page bg-white p-8 rounded-xl shadow-lg border-2 border-green-200">
            <h3 class="text-2xl font-bold text-center mb-6 text-green-800">はじめよう！</h3>
            <div class="space-y-6">
                <div>
                    <label for="grade" class="block text-lg font-bold text-gray-700 mb-2">① がくねん を おしえてね</label>
                    <select id="grade" class="w-full p-3 border border-gray-300 rounded-lg text-lg focus:ring-2 focus:ring-green-500">
                        <option>小学校 低学年</option>
                        <option selected>小学校 中学年</option>
                        <option>小学校 高学年</option>
                        <option>中学生</option>
                    </select>
                </div>
                <div>
                    <label for="animal" class="block text-lg font-bold text-gray-700 mb-2">② きょうみのある どうぶつ は？</label>
                    <input type="text" id="animal" value="コアラ" class="w-full p-3 border border-gray-300 rounded-lg text-lg focus:ring-2 focus:ring-green-500" placeholder="例：ライオン、カブトムシ">
                </div>
                <button id="get-themes-btn" class="w-full bg-yellow-400 hover:bg-yellow-500 text-gray-800 font-bold text-xl py-4 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 disabled:bg-gray-300 disabled:cursor-not-allowed">
                    AIにテーマを考えてもらう！
                </button>
                <div id="api-error" class="error-message"></div>
            </div>
        </div>

        <!-- Page 2: AI Suggestions -->
        <div id="page-suggestions" class="page hidden">
            <div id="loading" class="text-center p-8">
                <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-green-600 mx-auto"></div>
                <p class="mt-4 text-lg font-semibold text-green-700">AIががんばって考えているよ...</p>
            </div>
            <div id="suggestions-content" class="hidden">
                 <h3 class="text-2xl font-bold text-center mb-6 text-green-800">AIから３つのテーマがとどいたよ！</h3>
                 <p class="text-center text-gray-600 mb-6">やってみたい研究を選んでね。</p>
                <div id="themes-container" class="space-y-4">
                    <!-- AI themes will be inserted here by JavaScript -->
                </div>
                 <button id="back-to-input-btn" class="mt-6 w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 px-4 rounded-lg">もどる</button>
            </div>
        </div>

        <!-- Page 3: Observation Notebook -->
        <div id="page-notebook" class="page hidden bg-white p-8 rounded-xl shadow-lg border-2 border-green-200">
            <h3 class="text-xl font-bold text-center mb-1 text-green-800">たんけんノート</h3>
            <h4 id="notebook-title" class="text-2xl font-bold text-center mb-6 bg-green-100 p-3 rounded-lg"></h4>
            <div class="space-y-6">
                 <div>
                    <label class="block text-lg font-bold text-gray-700 mb-2">おなまえ</label>
                    <input type="text" id="user-name" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="どうぶつ はかせ">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-lg font-bold text-gray-700 mb-2">かんさつした日</label>
                        <input type="date" id="obs-date" class="w-full p-3 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-lg font-bold text-gray-700 mb-2">天気</label>
                        <input type="text" id="obs-weather" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="晴れ">
                    </div>
                </div>
                <div>
                    <label class="block text-lg font-bold text-gray-700 mb-2">なにをしていた？</o>
                    <textarea id="obs-action" rows="3" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="ほとんど寝ていた。たまにユーカリの葉を食べていた。"></textarea>
                </div>
                <div>
                    <label class="block text-lg font-bold text-gray-700 mb-2">きづいたこと・ふしぎにおもったこと</label>
                    <textarea id="obs-discovery" rows="5" class="w-full p-3 border border-gray-300 rounded-lg" placeholder="ユーカリの葉っぱのにおいをかいでから食べていた。好ききらいがあるのかな？"></textarea>
                </div>
                <div>
                    <label class="block text-lg font-bold text-gray-700 mb-2">写真やスケッチをアップロード</label>
                    <input type="file" id="obs-file" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-100 file:text-green-700 hover:file:bg-green-200"/>
                </div>
                <button id="create-report-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold text-xl py-4 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                    レポートを作成する！
                </button>
            </div>
        </div>

        <!-- Page 4: Report Preview -->
        <div id="page-report" class="page hidden bg-white p-8 rounded-xl shadow-lg border-4 border-blue-300">
            <h3 class="font-jp-title text-3xl font-bold text-center mb-4 text-blue-800">自由研究レポート（プレビュー）</h3>
            <div id="report-content" class="prose max-w-none">
                <h1 id="report-title" class="text-center"></h1>
                <p class="text-center text-lg"><strong>名前:</strong> <span id="report-name"></span></p>
                <hr class="my-6">
                
                <h3>はじめに</h3>
                <p>わたしは、<span id="report-animal-intro"></span>にきょうみがあったので、このテーマを研究することにしました。</p>

                <h3>かんさつの記録</h3>
                <ul>
                    <li><strong>かんさつした日:</strong> <span id="report-date"></span></li>
                    <li><strong>天気:</strong> <span id="report-weather"></span></li>
                </ul>

                <h3>かんさつの内容</h3>
                <h4>なにをしていた？</h4>
                <p id="report-action"></p>

                <h3>わかったこと・考えたこと</h3>
                <h4>きづいたこと・ふしぎにおもったこと</h4>
                <p id="report-discovery"></p>
                
                <h3>しゃしん・スケッチ</h3>
                <div id="report-image-container" class="my-4 p-4 border-2 border-dashed rounded-lg text-center bg-gray-50">
                    <p class="text-gray-500">ここにアップロードした画像が表示されます</p>
                </div>

                <h3>まとめ・かんそう</h3>
                <p>今回のかんさつで、<span id="report-animal-summary"></span>の新しい一面を知ることができました。次は、<span class="bg-yellow-200">[ここに次の研究テーマを書いてみよう]</span>についても調べてみたいです。</p>
            </div>
            <button onclick="alert('PDFがダウンロードされました！ (このサイトでは実際のダウンロードは行われません)')" class="mt-8 w-full bg-green-600 hover:bg-green-700 text-white font-bold text-xl py-4 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                PDFでダウンロード
            </button>
             <button id="back-to-notebook-btn" class="mt-4 w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 px-4 rounded-lg">たんけんノートにもどる</button>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const pages = {
            input: document.getElementById('page-input'),
            suggestions: document.getElementById('page-suggestions'),
            notebook: document.getElementById('page-notebook'),
            report: document.getElementById('page-report'),
        };
        const getThemesBtn = document.getElementById('get-themes-btn');
        const loadingDiv = document.getElementById('loading');
        const suggestionsContent = document.getElementById('suggestions-content');
        const themesContainer = document.getElementById('themes-container');
        const createReportBtn = document.getElementById('create-report-btn');
        const backToInputBtn = document.getElementById('back-to-input-btn');
        const backToNotebookBtn = document.getElementById('back-to-notebook-btn');
        const apiErrorDiv = document.getElementById('api-error');

        // --- State ---
        let userChoices = {
            grade: '',
            animal: '',
            theme: '',
        };

        // --- Functions ---
        
        function showPage(pageName) {
            Object.values(pages).forEach(page => page.classList.add('hidden'));
            if (pages[pageName]) {
                pages[pageName].classList.remove('hidden');
            }
        }

        function showApiError(message) {
            apiErrorDiv.textContent = message;
            apiErrorDiv.style.display = 'block';
        }

        function hideApiError() {
            apiErrorDiv.style.display = 'none';
        }

        /**
         * サーバーレス関数を呼び出して研究テーマを取得します。
         * @param {string} grade - The user's grade level.
         * @param {string} animal - The animal of interest.
         * @returns {Promise<Array<Object>>} - A promise that resolves to an array of theme objects.
         */
        async function callServerlessApi(grade, animal) {
            // このサイト専用のプロンプトをここで組み立てます。
            const prompt = `
あなたは子供向けの自由研究アドバイザーです。以下の条件で、動物園で観察できる面白くて学びのある自由研究の課題を3つ提案してください。
子供にもわかる簡単な言葉で、何を観察すればよいかのヒントも具体的に添えてください。

# 条件
* 学年: ${grade}
* 興味のある動物: ${animal}
`;
            // Vercelでデプロイされたサーバーレス関数を呼び出します。
            const response = await fetch('/api/generate-themes', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ prompt: prompt }),
            });

            // ▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼
            // 【エラー修正】応答がJSONでない場合も考慮した、より安全なエラー処理
            if (!response.ok) {
                const contentType = response.headers.get("content-type");
                let errorMessage;
                // サーバーからのエラー応答がJSON形式の場合
                if (contentType && contentType.includes("application/json")) {
                    const errorData = await response.json();
                    errorMessage = errorData.error || 'サーバーでエラーが発生しました。';
                } else {
                    // サーバーからのエラー応答がHTML形式の場合 (404 Not Foundなど)
                    errorMessage = `APIの読み込みに失敗しました (Error: ${response.status})。Vercelのデプロイ設定やフォルダ構成を確認してください。`;
                }
                throw new Error(errorMessage);
            }
            // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

            // 応答が正常 (200 OK) であれば、JSONとして解析して返す
            return response.json();
        }


        function displayThemes(themes) {
            themesContainer.innerHTML = ''; // Clear previous themes
            if (!themes || themes.length === 0) {
                 themesContainer.innerHTML = '<p class="text-center text-red-600">テーマの取得に失敗しました。もう一度試してください。</p>';
                return;
            }
            themes.forEach(theme => {
                const themeCard = document.createElement('div');
                themeCard.className = 'bg-white p-6 rounded-lg shadow-md border-2 border-transparent hover:border-yellow-400 hover:shadow-xl cursor-pointer transition';
                themeCard.innerHTML = `
                    <h4 class="text-xl font-bold text-green-800">${theme.title}</h4>
                    <p class="text-gray-600 mt-2">${theme.description}</p>
                    <button class="select-theme-btn mt-4 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">このテーマにする！</button>
                `;
                themeCard.querySelector('.select-theme-btn').addEventListener('click', () => {
                    userChoices.theme = theme.title;
                    document.getElementById('notebook-title').textContent = userChoices.theme;
                    showPage('notebook');
                });
                themesContainer.appendChild(themeCard);
            });
        }
        
        function populateReport() {
            document.getElementById('report-title').textContent = userChoices.theme;
            document.getElementById('report-name').textContent = document.getElementById('user-name').value || '（なまえ）';
            document.getElementById('report-animal-intro').textContent = userChoices.animal;
            document.getElementById('report-date').textContent = document.getElementById('obs-date').value || '（日付）';
            document.getElementById('report-weather').textContent = document.getElementById('obs-weather').value || '（天気）';
            document.getElementById('report-action').textContent = document.getElementById('obs-action').value || '（記録なし）';
            document.getElementById('report-discovery').textContent = document.getElementById('obs-discovery').value || '（記録なし）';
            document.getElementById('report-animal-summary').textContent = userChoices.animal;

            const fileInput = document.getElementById('obs-file');
            const imageContainer = document.getElementById('report-image-container');
            if (fileInput.files && fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imageContainer.innerHTML = `<img src="${e.target.result}" alt="アップロードされた画像" class="max-w-full max-h-60 mx-auto rounded-lg shadow-sm">`;
                }
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                imageContainer.innerHTML = '<p class="text-gray-500">画像はアップロードされませんでした</p>';
            }
        }

        // --- Event Listeners ---
        getThemesBtn.addEventListener('click', async () => {
            userChoices.grade = document.getElementById('grade').value;
            userChoices.animal = document.getElementById('animal').value;

            if (!userChoices.animal) {
                alert('動物の名前をいれてね！');
                return;
            }
            
            getThemesBtn.disabled = true;
            getThemesBtn.textContent = '考え中...';
            hideApiError();
            showPage('suggestions');
            loadingDiv.classList.remove('hidden');
            suggestionsContent.classList.add('hidden');

            try {
                const themes = await callServerlessApi(userChoices.grade, userChoices.animal);
                displayThemes(themes);
                loadingDiv.classList.add('hidden');
                suggestionsContent.classList.remove('hidden');
            } catch (error) {
                console.error("Failed to get themes from API:", error);
                showPage('input'); 
                showApiError(error.message || 'AIとの通信に失敗しました。少し時間をおいてから、もう一度試してください。');
            } finally {
                getThemesBtn.disabled = false;
                getThemesBtn.textContent = 'AIにテーマを考えてもらう！';
            }
        });

        createReportBtn.addEventListener('click', () => {
            populateReport();
            showPage('report');
        });

        backToInputBtn.addEventListener('click', () => showPage('input'));
        backToNotebookBtn.addEventListener('click', () => showPage('notebook'));

        // --- Initial Setup ---
        document.getElementById('obs-date').valueAsDate = new Date();
        showPage('input');

    </script>
</body>
</html>
